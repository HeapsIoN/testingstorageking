//%attributes = {"lang":"en"} comment added and reserved by 4D.
// 
// proxy_WS_GetInvNo
// http://bender.stellar.storman.com:19812/4DWSDL
// 
// Method source code automatically generated by the 4D SOAP wizard.
// ----------------------------------------------------------------

C_TEXT(WS_Error)
C_LONGINT(WS_NextFacilityInvNo;$j;$0)
$j:=1//10479
$FacilityCode:=[Facility]FacilityCode
WEB SERVICE SET PARAMETER("WS_FacilityCode";$FacilityCode)
$PortPos:=Position(":";[Facility]CentralAddress)
If ($PortPos>0)
$PortString:=Substring([Facility]CentralAddress;$PortPos+1)
Else 
$PortString:="19812"
End if 

Repeat //Three times will try to connect to the server if $Error#0 - 10479
$Port:=Num($PortString)
$Error:=IT_SetTimeOut (1)
$Error:=TCP_Open (GetDNS ("MV");$Port;$TCPID;0)
$j:=$j+1
Until (($Error#0) | ($j>3))


If ($Error=0)
$Error:=TCP_Close ($TCPID)
WEB SERVICE CALL("https://"+GetDNS ("MV")+":"+$PortString+"/4DSOAP/";"Storman#WS_GetInvNo";"WS_GetInvNo";"http://192.168.2.229/4dwsdl";Web Service dynamic)
If (OK=1)
WEB SERVICE GET RESULT(WS_Error;"WS_Error")
WEB SERVICE GET RESULT(WS_NextFacilityInvNo;"WS_NextFacilityInvNo";*)// Memory clean-up on the final return value.

$InvContinue:=False

If (Not(Semaphore("<>bNextInvNo";1800)))
$InvContinue:=True
End if 

If ($InvContinue)
$arraypos:=Find in array(<>asSiteCodes;[Facility]FacilityCode)
<>aiNextInvNo{$arraypos}:=WS_NextFacilityInvNo
If (Application type=4D Remote mode)
VARIABLE TO VARIABLE(-1;<>aiNextInvNo;<>aiNextInvNo)
End if 

CLEAR SEMAPHORE("<>bNextInvNo")
End if 

$0:=WS_NextFacilityInvNo

Else 
$InvContinue:=False

If (Not(Semaphore("<>bNextInvNo";1800)))
$InvContinue:=True
End if 

If ($InvContinue)
If (Application type=4D Remote mode)
GET PROCESS VARIABLE(-1;<>aiNextInvNo;<>aiNextInvNo)
End if 
$arraypos:=Find in array(<>asSiteCodes;[Facility]FacilityCode)
<>aiNextInvNo{$arraypos}:=WS_NextFacilityInvNo
If (Application type=4D Remote mode)
VARIABLE TO VARIABLE(-1;<>aiNextInvNo;<>aiNextInvNo)
End if 

CLEAR SEMAPHORE("<>bNextInvNo")
Else 
$0:=[Facility]NextInvNo
End if 
End if 
Else 

$InvContinue:=False

If (Not(Semaphore("<>bNextInvNo";1800)))
$InvContinue:=True
End if 

If ($InvContinue)
If (Application type=4D Remote mode)
GET PROCESS VARIABLE(-1;<>aiNextInvNo;<>aiNextInvNo)
End if 

//Hamid Modified Code below to get the Next Inv No - 18/4/2016

//$arraypos:=Find in array(<>asSiteCodes;[Facility]FacilityCode) 
//<>aiNextInvNo{$arraypos}:=WS_NextFacilityInvNo 
$arraypos:=Find in array(<>asSiteCodes;[Facility]FacilityCode)
QUERY([Trxs];[Trxs]AgreeNo=[Facility]FacilityCode+"@";*)
QUERY([Trxs]; & ;[Trxs]InvNo>=<>aiNextInvNo{$arraypos})
ORDER BY([Trxs];[Trxs]InvNo;<)

<>aiNextInvNo{$arraypos}:=[Trxs]InvNo
<>aiNextInvNo{$arraypos}:=<>aiNextInvNo{$arraypos}+1

$0:=<>aiNextInvNo{$arraypos}
If (Application type=4D Remote mode)
VARIABLE TO VARIABLE(-1;<>aiNextInvNo;<>aiNextInvNo)
End if 

CLEAR SEMAPHORE("<>bNextInvNo")
Else 
$0:=[Facility]NextInvNo
End if 
End if 
