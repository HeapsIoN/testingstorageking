//%attributes = {"lang":"en"} comment added and reserved by 4D.
// 
// GetCustomerDetailsXmlStringV2
// https://test.paymentxchange.com.au/PaymentExchange.asmx?WSDL
// 
// Method source code automatically generated by the 4D SOAP wizard.
// ----------------------------------------------------------------

C_TEXT($1)
C_TEXT($2)
C_TEXT($3)
C_TEXT($0)

C_TEXT($root)
C_TEXT($subelem)
C_TEXT($namespace;$oldErrMethod)

$oldErrMethod:=Method called on error
ON ERR CALL("ERR_Ezi")

$namespace:="https://px.ezidebit.com.au/"
$root:=DOM Create XML Ref("GetCustomerDetails";$namespace)

$subelem:=DOM Create XML element($root;"/GetCustomerDetails/DigitalKey")
DOM SET XML ELEMENT VALUE($subelem;$1)

$subelem:=DOM Create XML element($root;"/GetCustomerDetails/EziDebitCustomerID")
DOM SET XML ELEMENT VALUE($subelem;$2)

$subelem:=DOM Create XML element($root;"/GetCustomerDetails/YourSystemReference")
DOM SET XML ELEMENT VALUE($subelem;$3)

WEB SERVICE SET PARAMETER("XMLIn";$root)

DOM EXPORT TO VAR($root;$Message)
//SET TEXT TO PASTEBOARD($Message)
SyncRecordLog ("EziDebit GetCustomerDetails. Highlander: "+String([Facility]Highlander)+" Request: "+$Message)

If ([Facility]Highlander)
If ([Facility]TestAccount)
//WEB SERVICE CALL("https://test.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/GetCustomerDetailsXmlStringV2";"GetCustomerDetailsXmlStringV2";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.demo.ezidebit.com.au/v3-5/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetCustomerDetails";"GetCustomerDetails";"https://px.ezidebit.com.au/";Web Service manual)

Else 
//WEB SERVICE CALL("https://live.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/GetCustomerDetailsXmlStringV2";"GetCustomerDetailsXmlStringV2";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.ezidebit.com.au/v3-5/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetCustomerDetails";"GetCustomerDetails";"https://px.ezidebit.com.au/";Web Service manual)

End if 
Else 
If ([Facility]TestAccount)
//WEB SERVICE CALL("https://test.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/GetCustomerDetailsXmlStringV2";"GetCustomerDetailsXmlStringV2";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.demo.ezidebit.com.au/v3-3/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetCustomerDetails";"GetCustomerDetails";"https://px.ezidebit.com.au/";Web Service manual)

Else 
//WEB SERVICE CALL("https://live.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/GetCustomerDetailsXmlStringV2";"GetCustomerDetailsXmlStringV2";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.ezidebit.com.au/v3-3/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetCustomerDetails";"GetCustomerDetails";"https://px.ezidebit.com.au/";Web Service manual)

End if 
End if 

$EziResult:=Num(WEB SERVICE Get info(0))

If ($EziResult=0)
C_BLOB($blob)
C_TEXT($resroot)
C_TEXT($ressubelem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)
$text:=Convert to text($blob;"UTF-8")
$text:=Replace string($text;"&lt;";"<")
$resroot:=DOM Parse XML variable($text)

DOM EXPORT TO VAR($resroot;$Message)
//SET TEXT TO PASTEBOARD($Message)
SyncRecordLog ("EziDebit GetCustomerDetails Response: "+$Message)

//$ressubelem:=DOM Find XML element($resroot;"/GetCustomerDetailsXmlStringV2Response/GetCustomerDetailsXmlStringV2Result/Custom"+"erDetails/CustomerDetail/StatusCode")
$ressubelem:=DOM Find XML element($resroot;"/GetCustomerDetailsResponse/GetCustomerDetailsResult/Data/StatusCode")
DOM GET XML ELEMENT VALUE($ressubelem;$0)
$ressubelem:=DOM Find XML element($resroot;"/GetCustomerDetailsResponse/GetCustomerDetailsResult/Data/EzidebitCustomerID")
DOM GET XML ELEMENT VALUE($ressubelem;$EziDebitCustomerID)
$0:=$0+","+$EziDebitCustomerID
DOM CLOSE XML($resroot)

Else 
SyncRecordLog ("EziDebit GetCustomerDetails call result: "+String($EziResult)+" Message: "+gError)
End if 

DOM CLOSE XML($root)
ON ERR CALL($oldErrMethod)
