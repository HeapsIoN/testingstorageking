//%attributes = {"lang":"en"} comment added and reserved by 4D.
// 
// WSC_AdvamDDTransactionComplete
// https://demo-ftp.advam.com/batch/ws/V1/BulkSubmission.wsdl
// 
// Method source code automatically generated by the 4D SOAP wizard.
// ----------------------------------------------------------------

C_TEXT($1;$2;$3;$4)
C_TEXT($0;$statement_xpath;$value_t;$5;$ErrMethod)
C_BLOB($outputblob;$replyblob)
C_TEXT($xmlref;$xmlnode)
C_LONGINT($TCPID)

SET BLOB SIZE($outputblob;0)

$TCPID:=0

vAdvamAcc:=$1

vUser:=$2
vPass:=$3
vBatch:=$4
vMD5:=$5

$ErrMethod:=Method called on error
ON ERR CALL("ErrorNone")
//If (<>iPlatform=3)
//If (<>tClient) & (Application type=4D Remote Mode)
//DOCUMENT TO BLOB(<>sStormanPath+"Win4DX\\DDCompleteSOAP.xml";$inputblob)
//Else 
//DOCUMENT TO BLOB(<>sStormanPath+"Database\\Win4DX\\DDCompleteSOAP.xml";$inputblob)
//End if 
//Else 
//DOCUMENT TO BLOB(<>sStormanPath+"Mac4DX\\DDCompleteSOAP.xml";$inputblob)
//End if 
//PROCESS HTML TAGS($inputblob;$outputblob)
//SET WEB SERVICE PARAMETER("XMLIn";$outputblob)


// Modified by: nicholas.wykes (7/01/2010)
//Change from disk file to DOM XML format

$root:=DOM Create XML Ref("CompleteRequest";"http://batch.advam.com/V1/schema")

$subelem:=DOM Create XML element($root;"/CompleteRequest/AdvamAccount")
DOM SET XML ELEMENT VALUE($subelem;vAdvamAcc)

$subelem:=DOM Create XML element($root;"/CompleteRequest/OperatorUsername")
DOM SET XML ELEMENT VALUE($subelem;vUser)

$subelem:=DOM Create XML element($root;"/CompleteRequest/OperatorPassword")
DOM SET XML ELEMENT VALUE($subelem;vPass)

$subelem:=DOM Create XML element($root;"/CompleteRequest/Batch")
DOM SET XML ELEMENT VALUE($subelem;vBatch)

$subelem:=DOM Create XML element($root;"/CompleteRequest/MD5")
DOM SET XML ELEMENT VALUE($subelem;vMD5)

WEB SERVICE SET PARAMETER("XMLIn";$root)

DOM CLOSE XML($root)


ON ERR CALL("ErrorWS")
If ([Facility]TestAccount)//Test Account / Server
$Error:=TCP_Open ("demo-ftp.advam.com";443;$TCPID;0)
If ($Error=0)
$Error:=TCP_Close ($TCPID)
$Error:=IT_SetTimeOut (65)
WEB SERVICE CALL("https://demo-ftp.advam.com/batch/ws/V1/soap.php";"http://batch.advam.com/V1/schema";"Complete";"";Web Service manual)
End if 
Else //Live Account / Server
$Error:=TCP_Open ("ftp.advam.com";443;$TCPID;0)
If ($Error=0)
$Error:=TCP_Close ($TCPID)
$Error:=IT_SetTimeOut (65)
WEB SERVICE CALL("https://ftp.advam.com/batch/ws/V1/soap.php";"http://batch.advam.com/V1/schema";"Complete";"";Web Service manual)
End if 
End if 


If (OK=1)
WEB SERVICE GET RESULT($replyblob;"XMLOut";*)
$xmlref:=DOM Parse XML variable($replyblob)
$statement_xpath:="/CompleteResponse/Success"
$xmlnode:=DOM Find XML element($xmlref;$statement_xpath)

If ($xmlnode#"0000000000000000")
DOM GET XML ELEMENT VALUE($xmlnode;$value_t)
WS_AdvamSuccess:=$value_t
End if 

$statement_xpath:="/CompleteResponse/Status"
$xmlnode:=DOM Find XML element($xmlref;$statement_xpath)

If ($xmlnode#"0000000000000000")
DOM GET XML ELEMENT VALUE($xmlnode;$value_t)
WS_AdvamStatus:=$value_t
End if 

DOM CLOSE XML($xmlref)
If (WS_AdvamSuccess="true") | (WS_AdvamSuccess="1")
$0:=WS_AdvamStatus
Else 
$0:=""
End if 
End if 

$Error:=IT_SetTimeOut (30)
ON ERR CALL($ErrMethod)
