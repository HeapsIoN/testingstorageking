//%attributes = {"lang":"en"} comment added and reserved by 4D.
// 
// WSC_EzidebitGetCustAccDetails
// 
// 
// Method source code automatically generated by the 4D SOAP wizard.
// ----------------------------------------------------------------

C_TEXT($1)
C_TEXT($2)
C_TEXT($3)
C_TEXT($0)
C_TEXT($AccountHolderName)
C_TEXT($AccountNumber)
C_TEXT($BSB)
C_TEXT($CardHolderName)
C_TEXT($CreditCardNumber)
C_LONGINT($ExpiryMonth)
C_LONGINT($ExpiryYear)
C_TEXT($PaymentMethod)
C_LONGINT($Error)
C_TEXT($ErrorMessage)
C_LONGINT($EziResult)
C_TEXT($root)
C_TEXT($subElem)
C_TEXT($nameSpace)

$nameSpace:="https://px.ezidebit.com.au/"
$root:=DOM Create XML Ref("GetCustomerAccountDetails";$nameSpace)

$subElem:=DOM Create XML element($root;"/GetCustomerAccountDetails/DigitalKey")
DOM SET XML ELEMENT VALUE($subElem;$1)

$subElem:=DOM Create XML element($root;"/GetCustomerAccountDetails/EzidebitCustomerID")
DOM SET XML ELEMENT VALUE($subElem;$2)

$subElem:=DOM Create XML element($root;"/GetCustomerAccountDetails/YourSystemReference")
DOM SET XML ELEMENT VALUE($subElem;$3)

WEB SERVICE SET PARAMETER("XMLIn";$root)
DOM EXPORT TO VAR($root;$Message)
SyncRecordLog ("EziDebit WSC_EzidebitGetCustAccDetails Request: "+$Message)

If ([Facility]Highlander)
If ([Facility]TestAccount)
WEB SERVICE CALL("https://api.demo.ezidebit.com.au/v3-5/pci";"https://px.ezidebit.com.au/IPCIService/GetCustomerAccountDetails";"GetCustomerAccountDetails";"https://px.ezidebit.com.au/";Web Service manual)
Else 
WEB SERVICE CALL("https://api.ezidebit.com.au/v3-5/pci";"https://px.ezidebit.com.au/IPCIService/GetCustomerAccountDetails";"GetCustomerAccountDetails";"https://px.ezidebit.com.au/";Web Service manual)
End if 
Else 
If ([Facility]TestAccount)
WEB SERVICE CALL("https://api.demo.ezidebit.com.au/v3-5/pci";"https://px.ezidebit.com.au/IPCIService/GetCustomerAccountDetails";"GetCustomerAccountDetails";"https://px.ezidebit.com.au/";Web Service manual)
Else 
WEB SERVICE CALL("https://api.ezidebit.com.au/v3-5/pci";"https://px.ezidebit.com.au/IPCIService/GetCustomerAccountDetails";"GetCustomerAccountDetails";"https://px.ezidebit.com.au/";Web Service manual)
End if 
End if 

$EziResult:=Num(WEB SERVICE Get info(0))

If ($EziResult=0)//If (OK=1)
C_BLOB($blob)
_o_C_STRING(16;$resRoot)
_o_C_STRING(16;$resSubElem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)

$resRoot:=DOM Parse XML variable($blob)

DOM EXPORT TO VAR($resroot;$Message)
SyncRecordLog ("EziDebit WSC_EzidebitGetCustAccDetails Response: "+$Message)


$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/Error")
DOM GET XML ELEMENT VALUE($resSubElem;$Error)

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/ErrorMessage")
DOM GET XML ELEMENT VALUE($resSubElem;$ErrorMessage)

If ($Error=0)

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/Data/AccountHolderName")
DOM GET XML ELEMENT VALUE($resSubElem;$AccountHolderName)

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/Data/AccountNumber")
DOM GET XML ELEMENT VALUE($resSubElem;$AccountNumber)

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/Data/BSB")
DOM GET XML ELEMENT VALUE($resSubElem;$BSB)

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/Data/CardHolderName")
DOM GET XML ELEMENT VALUE($resSubElem;$CardHolderName)

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/Data/CreditCardNumber")
DOM GET XML ELEMENT VALUE($resSubElem;$CreditCardNumber)

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/Data/ExpiryMonth")
DOM GET XML ELEMENT VALUE($resSubElem;$ExpiryMonth)

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/Data/ExpiryYear")
DOM GET XML ELEMENT VALUE($resSubElem;$ExpiryYear)

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerAccountDetailsResponse/GetCustomerAccountDetailsResult/Data/PaymentMethod")
DOM GET XML ELEMENT VALUE($resSubElem;$PaymentMethod)


$0:="S"
[Customer]CCName:=$CardHolderName
//[Customer]CCNo:="xxxxxxxxxxxx"+Substring($CreditCardNumber;Length($CreditCardNumber)-3;4)

If ($ExpiryMonth<10)
[Customer]CCExpiry:="0"+String($ExpiryMonth)+Substring(String($ExpiryYear);3;2)
Else 
Customer]CCExpiry:=String($ExpiryMonth)+Substring(String($ExpiryYear);3;2)
End if 

[Customer]SpecialOption:=54

If ($CreditCardNumber="51@") | ($CreditCardNumber="52@") | ($CreditCardNumber="53@") | ($CreditCardNumber="54@") | ($CreditCardNumber="55@")//MC
[Customer]SpecialOption:=62
End if 

If ($CreditCardNumber="37@") | ($CreditCardNumber="34@")//It is an Amex card
[Customer]SpecialOption:=55
End if 
If (($CreditCardNumber="300@") | ($CreditCardNumber="301@") | ($CreditCardNumber="38@") | ($CreditCardNumber="39@") | ($CreditCardNumber="309@") | ($CreditCardNumber="302@") | ($CreditCardNumber="303@") | ($CreditCardNumber="304@") | ($CreditCardNumber="305@") | ($CreditCardNumber="36@")) & (([Facility]Country#"US") & ([Facility]Country#"CA"))//10461 - adding new Diners CC number
[Customer]SpecialOption:=56
End if 
Else 
$0:="ERR"+String($Error)
AlertMessage ($ErrorMessage)
End if 

DOM CLOSE XML($resRoot)

Else 
AlertMessage ("EziDebit call result, error code: "+String($EziResult)+" (Unable to process request)")
SyncRecordLog ("EziDebit WSC_EzidebitGetCustAccDetails call result: "+String($EziResult)+" Message: "+gError)
End if 

DOM CLOSE XML($root)

