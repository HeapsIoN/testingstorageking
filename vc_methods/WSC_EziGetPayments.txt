//%attributes = {"lang":"en"} comment added and reserved by 4D.

// ----------------------------------------------------
// User name (OS): denis.mikheev
// Date and time: 10/02/15, 09:25:07
// ----------------------------------------------------
// Method: WSC_EziGetPayments
// Description
// Method to retrive status of real time transactions
//
// Parameters
// ----------------------------------------------------

// 
// GetPaymentDetailXmlString
// https://test.paymentxchange.com.au/PaymentExchange.asmx?WSDL
// 
// Method source code automatically generated by the 4D SOAP wizard.
// ----------------------------------------------------------------

C_TEXT($1)
C_TEXT($2)
C_TEXT($0)

C_TEXT($root)
C_TEXT($subelem)
C_TEXT($namespace;$oldErrMethod)

$oldErrMethod:=Method called on error
ON ERR CALL("Err_EziGetPaymentStatus")
gError:=""
$namespace:="https://px.ezidebit.com.au/"
$root:=DOM Create XML Ref("GetPayments";$namespace)

$subelem:=DOM Create XML element($root;"/GetPayments/DigitalKey")
DOM SET XML ELEMENT VALUE($subelem;$1)

$subelem:=DOM Create XML element($root;"/GetPayments/PaymentType")
DOM SET XML ELEMENT VALUE($subelem;"ALL")

$subelem:=DOM Create XML element($root;"/GetPayments/PaymentMethod")
DOM SET XML ELEMENT VALUE($subelem;"ALL")

$subelem:=DOM Create XML element($root;"/GetPayments/PaymentSource")
DOM SET XML ELEMENT VALUE($subelem;"ALL")

$subelem:=DOM Create XML element($root;"/GetPayments/PaymentReference")
DOM SET XML ELEMENT VALUE($subelem;$2)

$subelem:=DOM Create XML element($root;"/GetPayments/DateFrom")
DOM SET XML ELEMENT VALUE($subelem;"")

$subelem:=DOM Create XML element($root;"/GetPayments/DateTo")
DOM SET XML ELEMENT VALUE($subelem;"")

$subelem:=DOM Create XML element($root;"/GetPayments/DateField")
DOM SET XML ELEMENT VALUE($subelem;"")

$subelem:=DOM Create XML element($root;"/GetPayments/EziDebitCustomerID")
DOM SET XML ELEMENT VALUE($subelem;"")

$subelem:=DOM Create XML element($root;"/GetPayments/YourSystemReference")
DOM SET XML ELEMENT VALUE($subelem;"")


WEB SERVICE SET PARAMETER("XMLIn";$root)

DOM EXPORT TO VAR($root;$Message)
//SET TEXT TO PASTEBOARD($Message)
SyncRecordLog ("EziDebit GetPayments. Highlander: "+String([Facility]Highlander)+" Request: "+$Message)

If ([Facility]Highlander)
If ([Facility]TestAccount)
//WEB SERVICE CALL("https://test.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/GetPaymentDetailXmlString";"GetPaymentDetailXmlString";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.demo.ezidebit.com.au/v3-5/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetPayments";"GetPayments";"https://px.ezidebit.com.au/";Web Service manual)
Else 
//WEB SERVICE CALL("https://live.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/GetPaymentDetailXmlString";"GetPaymentDetailXmlString";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.ezidebit.com.au/v3-5/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetPayments";"GetPayments";"https://px.ezidebit.com.au/";Web Service manual)
End if 
Else 
If ([Facility]TestAccount)
//WEB SERVICE CALL("https://test.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/GetPaymentDetailXmlString";"GetPaymentDetailXmlString";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.demo.ezidebit.com.au/v3-3/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetPayments";"GetPayments";"https://px.ezidebit.com.au/";Web Service manual)
Else 
//WEB SERVICE CALL("https://live.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/GetPaymentDetailXmlString";"GetPaymentDetailXmlString";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.ezidebit.com.au/v3-3/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetPayments";"GetPayments";"https://px.ezidebit.com.au/";Web Service manual)
End if 
End if 

$EziResult:=Num(WEB SERVICE Get info(0))

If ($EziResult=0)
C_BLOB($blob)
C_TEXT($resroot;$Amount;$SurchargeAmount)
C_TEXT($ressubelem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)
$text:=Convert to text($blob;"UTF-8")
$text:=Replace string($text;"&lt;";"<")
$text:=Replace string($text;"&gt;";">")
$resroot:=DOM Parse XML variable($text)

DOM EXPORT TO VAR($resroot;$Message)
SyncRecordLog ("EziDebit GetPayments Response: "+$Message)


//Need to check for amount as refunds can be passed as well
$ressubelem:=DOM Find XML element($resroot;"/GetPaymentsResponse/GetPaymentsResult/Data/Payment/PaymentAmount")
DOM GET XML ELEMENT VALUE($ressubelem;$Amount)

//20/11/15 DAM Added a check for Surcharge Amt
$ressubelem:=DOM Find XML element($resroot;"/GetPaymentsResponse/GetPaymentsResult/Data/Payment/TransactionFeeCustomer")
DOM GET XML ELEMENT VALUE($ressubelem;$SurchargeAmount)

//Parent Element
$ressubelem:=DOM Find XML element($resroot;"/GetPaymentsResponse/GetPaymentsResult/Data/Payment")

If ((Num($Amount)-Num($SurchargeAmount))=[Trxs]TotAmt)

$ressubelem:=DOM Find XML element($resroot;"/GetPaymentsResponse/GetPaymentsResult/Data/Payment/PaymentStatus")
DOM GET XML ELEMENT VALUE($ressubelem;$0)
If ($0="S")
$ressubelem:=DOM Find XML element($resroot;"/GetPaymentsResponse/GetPaymentsResult/Data/Payment/SettlementDate")
DOM GET XML ELEMENT VALUE($ressubelem;$stringDate)

//10/07/15 DAM Added for date banked
If ([Analysis]SetBankedDate=False)
[Trxs]DateBanked:=Date(Substring($stringDate;9;2)+"/"+Substring($stringDate;6;2)+"/"+Substring($stringDate;1;4))
End if 

End if 

If ($0="F")
$ressubelem:=DOM Find XML element($resroot;"/GetPaymentsResponse/GetPaymentsResult/Data/Payment/BankFailedReason")
DOM GET XML ELEMENT VALUE($ressubelem;gError)
End if 

DOM CLOSE XML($resroot)

Else 

$ressubelem:=DOM Get next sibling XML element($ressubelem)
ARRAY TEXT($arChildTypes;0)
ARRAY TEXT($arChildRef;0)
DOM GET XML CHILD NODES($ressubelem;$arChildTypes;$arChildRef)

//Payment Status
DOM GET XML ELEMENT VALUE($arChildRef{13};$0)
If ($0="S")
DOM GET XML ELEMENT VALUE($arChildRef{15};$stringDate)

//10/07/15 DAM Added for date banked
If ([Analysis]SetBankedDate=False)
[Trxs]DateBanked:=Date(Substring($stringDate;9;2)+"/"+Substring($stringDate;6;2)+"/"+Substring($stringDate;1;4))
End if 

End if 

If ($0="F")
DOM GET XML ELEMENT VALUE($arChildRef{1};gError)
End if 

DOM CLOSE XML($resroot)

End if 


Else 
SyncRecordLog ("EziDebit GetPayments call result: "+String($EziResult)+" Message: "+gError)
End if 

DOM CLOSE XML($root)
ON ERR CALL($oldErrMethod)
