//%attributes = {"lang":"en"} comment added and reserved by 4D.
// 
// AddPayment
// https://test.paymentxchange.com.au/PaymentExchange.asmx?WSDL
// 
// Method source code automatically generated by the 4D SOAP wizard.
// ----------------------------------------------------------------

C_TEXT($1)
C_TEXT($2)
C_TEXT($3)
C_TEXT($4)
C_TEXT($5)
C_TEXT($6)
C_TEXT($7)
C_BOOLEAN($8)//Show Errors
C_DATE($9)
C_TEXT($0)
C_LONGINT($EziResult;$Pos)

C_TEXT($DebitDate;$Errorl;vCCText)
C_TEXT($root)
C_TEXT($subelem)
C_TEXT($namespace)

$trxDate:=Current date
If (Count parameters>8)
$trxDate:=$9
End if 
vCCText:=""

$crlf:=Char(Carriage return)+Char(Line feed)

$namespace:="https://px.ezidebit.com.au/"
$root:=DOM Create XML Ref("AddPayment";$namespace)

$DebitDate:=String(Year of($trxDate))+"-"+String(Month of($trxDate);"0#")+"-"+String(Day of($trxDate);"0#")

$subelem:=DOM Create XML element($root;"/AddPayment/DigitalKey")
DOM SET XML ELEMENT VALUE($subelem;$1)

$subelem:=DOM Create XML element($root;"/AddPayment/EziDebitCustomerID")
DOM SET XML ELEMENT VALUE($subelem;$2)

$subelem:=DOM Create XML element($root;"/AddPayment/YourSystemReference")
DOM SET XML ELEMENT VALUE($subelem;$3)

$subelem:=DOM Create XML element($root;"/AddPayment/DebitDate")
DOM SET XML ELEMENT VALUE($subelem;$DebitDate)

$subelem:=DOM Create XML element($root;"/AddPayment/PaymentAmountInCents")
DOM SET XML ELEMENT VALUE($subelem;$5)

$subelem:=DOM Create XML element($root;"/AddPayment/PaymentReference")
DOM SET XML ELEMENT VALUE($subelem;$6)

$subelem:=DOM Create XML element($root;"/AddPayment/Username")
DOM SET XML ELEMENT VALUE($subelem;$7)

WEB SERVICE SET PARAMETER("XMLIn";$root)

DOM EXPORT TO VAR($root;$Message)
//SET TEXT TO PASTEBOARD($Message)
SyncRecordLog ("EziDebit ADDPayment. Highlander: "+String([Facility]Highlander)+" Request: "+$Message)

$oldErrMethod:=Method called on error
ON ERR CALL("ERR_Ezi")

If ([Facility]Highlander)
If ([Facility]TestAccount)
//WEB SERVICE CALL("https://test.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/AddPayment";"AddPayment";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.demo.ezidebit.com.au/v3-5/nonpci";"https://px.ezidebit.com.au/INonPCIService/AddPayment";"AddPayment";"https://px.ezidebit.com.au/";Web Service manual)
Else 
//WEB SERVICE CALL("https://live.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/AddPayment";"AddPayment";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.ezidebit.com.au/v3-5/nonpci";"https://px.ezidebit.com.au/INonPCIService/AddPayment";"AddPayment";"https://px.ezidebit.com.au/";Web Service manual)
End if 
Else 
If ([Facility]TestAccount)
//WEB SERVICE CALL("https://test.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/AddPayment";"AddPayment";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.demo.ezidebit.com.au/v3-3/nonpci";"https://px.ezidebit.com.au/INonPCIService/AddPayment";"AddPayment";"https://px.ezidebit.com.au/";Web Service manual)
Else 
//WEB SERVICE CALL("https://live.paymentxchange.com.au/PaymentExchange.asmx";"https://px.ezidebit.com.au/AddPayment";"AddPayment";"https://px.ezidebit.com.au/";Web Service Manual)
WEB SERVICE CALL("https://api.ezidebit.com.au/v3-3/nonpci";"https://px.ezidebit.com.au/INonPCIService/AddPayment";"AddPayment";"https://px.ezidebit.com.au/";Web Service manual)
End if 
End if 



$EziResult:=Num(WEB SERVICE Get info(0))

If ($EziResult=0)
C_BLOB($blob)
C_TEXT($resroot)
C_TEXT($ressubelem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)
$resroot:=DOM Parse XML variable($blob)
DOM EXPORT TO VAR($resroot;$Message)
//SET TEXT TO PASTEBOARD($Message)
SyncRecordLog ("EziDebit ADDPayment Response: "+$Message)

$ressubelem:=DOM Find XML element($resroot;"/AddPaymentResponse/AddPaymentResult/Error")
DOM GET XML ELEMENT VALUE($ressubelem;$0)

If ($0#"0")
$ressubelem:=DOM Find XML element($resroot;"/AddPaymentResponse/AddPaymentResult/ErrorMessage")
DOM GET XML ELEMENT VALUE($ressubelem;$Error)
End if 

DOM CLOSE XML($resroot)

If ($0="0")
$0:="S"
End if 

If ($0="S") | ($0="P")
[Trxs]CCTransID:=$6
Else 
If ($8) & (Not(IsAWebProcess ))
AlertMessage ($Error)
End if 
$0:="ERR"+$0
vCCText:=$Error
End if 
[Trxs]TrxDate:=$trxDate
Else 

C_BLOB($blob)
C_TEXT($resroot)
C_TEXT($ressubelem)
vCCText:=""
SyncRecordLog ("EziDebit ADDPayment call result: "+String($EziResult)+" Message: "+gError)

//03/06/15 DAM Added code for reading the error message from Ezidebit
$Pos:=0
$Pos:=Position("<s:Envelope";gError)

If ($Pos>0)
gError:=Substring(gError;$Pos)
TEXT TO BLOB(gError;$blob)
$resroot:=DOM Parse XML variable($blob)

$ressubelem:=DOM Find XML element($resroot;"/Envelope/Body/Fault/detail/ExceptionDetail/Message")
If ($ressubelem#"0000000000000000")
DOM GET XML ELEMENT VALUE($ressubelem;vCCText)
End if 
End if 

If (vCCText="")
vCCText:=gError
End if 

If ($8) & (Not(IsAWebProcess ))
AlertMessage (vCCText+$crlf+$crlf+"Customer Reference:"+$3)
End if 

$0:="ERROR"
End if 
ON ERR CALL($oldErrMethod)

DOM CLOSE XML($root)