//%attributes = {"lang":"en"} comment added and reserved by 4D.
// 
// WSC_AuthnetCreateCustProfTrx
// https://api.authorize.net/soap/v1/Service.asmx?WSDL
// 
// Method source code automatically generated by the 4D SOAP wizard.
// ----------------------------------------------------------------

C_TEXT($1)
C_TEXT($2)
C_TEXT($3)
C_TEXT($4)
C_TEXT($5)
C_TEXT($6)
C_BOOLEAN($7)
C_TEXT($8)
C_TEXT(AuthnetCCPTrxResultCode)
C_TEXT(AuthnetCCPTrxCode)
C_TEXT(AuthnetCCPTrxText)
C_LONGINT($WSCResult)

C_TEXT($root)
C_TEXT($subelem)
C_TEXT($namespace)
$namespace:="https://api.authorize.net/soap/v1/"
$root:=DOM Create XML Ref("CreateCustomerProfileTransaction";$namespace)

$oldErrMethod:=Method called on error

ON ERR CALL("ErrorNone")

$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/merchantAuthentication/name")//[Facility]MerchantDetails
DOM SET XML ELEMENT VALUE($subelem;$1)

$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/merchantAuthentication/transactionKey")//[Facility]MerchantDetails
DOM SET XML ELEMENT VALUE($subelem;$2)

Case of 
: ($3="P")
$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransAuthCapture/amount")//[Transaction]TotAmt
DOM SET XML ELEMENT VALUE($subelem;$4)

$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransAuthCapture/cust"+"omerProfileId")//[Customer]custProfID
DOM SET XML ELEMENT VALUE($subelem;$5)

$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransAuthCapture/cust"+"omerPaymentProfileId")//[Customer]custPaymentProfID
DOM SET XML ELEMENT VALUE($subelem;$6)


If ($7)
$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransAuthCapture/taxE"+"xempt")//[Agreement]TaxExempt
DOM SET XML ELEMENT VALUE($subelem;"1")
Else 
$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransAuthCapture/taxE"+"xempt")//[Agreement]TaxExempt
DOM SET XML ELEMENT VALUE($subelem;"0")
End if 

//$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransAuthCapture/taxE"+"xempt")  `[Agreement]TaxExempt
//DOM SET XML ELEMENT VALUE($subelem;$7)
: ($3="C")
$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransRefund/amount")//[Transaction]TotAmt
DOM SET XML ELEMENT VALUE($subelem;$4)

$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransRefund/cust"+"omerProfileId")//[Customer]custProfID
DOM SET XML ELEMENT VALUE($subelem;$5)

$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransRefund/cust"+"omerPaymentProfileId")//[Customer]custPaymentProfID
DOM SET XML ELEMENT VALUE($subelem;$6)


If ($7)
$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransRefund/taxE"+"xempt")//[Agreement]TaxExempt
DOM SET XML ELEMENT VALUE($subelem;"1")
Else 
$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransRefund/taxE"+"xempt")//[Agreement]TaxExempt
DOM SET XML ELEMENT VALUE($subelem;"0")
End if 

//$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransRefund/taxE"+"xempt")  `[Agreement]TaxExempt
//DOM SET XML ELEMENT VALUE($subelem;$7)

$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransRefund/transId")//[Transaction]CCTransID
DOM SET XML ELEMENT VALUE($subelem;$8)
: ($3="V")
$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransVoid/cust"+"omerProfileId")//[Customer]custProfID
DOM SET XML ELEMENT VALUE($subelem;$5)

$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransVoid/cust"+"omerPaymentProfileId")//[Customer]custPaymentProfID
DOM SET XML ELEMENT VALUE($subelem;$6)


If ($7)
$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransVoid/taxE"+"xempt")//[Agreement]TaxExempt
DOM SET XML ELEMENT VALUE($subelem;"1")
Else 
$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransVoid/taxE"+"xempt")//[Agreement]TaxExempt
DOM SET XML ELEMENT VALUE($subelem;"0")
End if 

//$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransVoid/taxE"+"xempt")  `[Agreement]TaxExempt
//DOM SET XML ELEMENT VALUE($subelem;$7)

$subelem:=DOM Create XML element($root;"/CreateCustomerProfileTransaction/transaction/profileTransVoid/transId")//[Transaction]CCTransID
DOM SET XML ELEMENT VALUE($subelem;$8)
End case 

WEB SERVICE SET PARAMETER("XMLIn";$root)


If ([Facility]TestAccount)//($1="863cxV6XMa") - 10261
WEB SERVICE CALL("https://apitest.authorize.net/soap/v1/Service.asmx";"https://api.authorize.net/soap/v1/CreateCustomerProfileTransaction";"CreateCustomerProfileTransaction";"https://api.authorize.net/soap/v1/";Web Service manual)
Else 
WEB SERVICE CALL("https://api.authorize.net/soap/v1/Service.asmx";"https://api.authorize.net/soap/v1/CreateCustomerProfileTransaction";"CreateCustomerProfileTransaction";"https://api.authorize.net/soap/v1/";Web Service manual)
End if 
$WSCResult:=Num(WEB SERVICE Get info(0))

If ($WSCResult=0)
C_BLOB($blob)
C_TEXT($resroot)
C_TEXT($ressubelem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)
$resroot:=DOM Parse XML variable($blob)

$ressubelem:=DOM Find XML element($resroot;"/CreateCustomerProfileTransactionResponse/CreateCustomerProfileTransactionResult/resultCode")
DOM GET XML ELEMENT VALUE($ressubelem;AuthnetCCPTrxResultCode)

$ressubelem:=DOM Find XML element($resroot;"/CreateCustomerProfileTransactionResponse/CreateCustomerProfileTransactionResult/messages/MessagesTypeMessage/code")
DOM GET XML ELEMENT VALUE($ressubelem;AuthnetCCPTrxCode)

$ressubelem:=DOM Find XML element($resroot;"/CreateCustomerProfileTransactionResponse/CreateCustomerProfileTransactionResult/messages/MessagesTypeMessage/text")
DOM GET XML ELEMENT VALUE($ressubelem;AuthnetCCPTrxText)

$ressubelem:=DOM Find XML element($resroot;"/CreateCustomerProfileTransactionResponse/CreateCustomerProfileTransactionResult/directResponse")
DOM GET XML ELEMENT VALUE($ressubelem;$Buffer)

DOM CLOSE XML($resroot)

If (AuthnetCCPTrxResultCode="Error")
If (Not(IsAWebProcess ))
AlertMessage (AuthnetCCPTrxCode+"-"+AuthnetCCPTrxText)
SyncRecordLog ("Error# "+AuthnetCCPTrxCode+"-"+AuthnetCCPTrxText)
Else 
AlertMessage (Get localized string("Transaction successful"))
End if 
$0:="ERR"
Else 
For ($i;1;7)//Fourteen fields
$j:=Position(",";$Buffer)
If ($j>1)
$Field:=Substring($Buffer;1;$j-1)
$Buffer:=Substring($Buffer;$j+1)
Case of 
: ($i=5)
$0:=$Field
: ($i=7)
[Trxs]CCTransID:=$Field
Else 
//do nothing
End case 
End if 
End for 
End if 

Else 
If (Not(IsAWebProcess ))
AlertMessage (Get localized string("There was an error contacting the AuthorizeNet CIM servers, try again later."))
SyncRecordLog (WEB SERVICE Get info(0)+" "+WEB SERVICE Get info(Web Service detailed message))
End if 
$0:="ERR4IC"
End if 

DOM CLOSE XML($root)
ON ERR CALL($oldErrMethod)
