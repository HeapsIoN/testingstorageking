//%attributes = {"lang":"en"} comment added and reserved by 4D.
// 
// proxy_SendTran
// https://ws.cert.transactionexpress.com/portal/merchantframework/MerchantWebServices-v1?wsdl
// 
// Method source code automatically generated by the 4D SOAP wizard.
// ----------------------------------------------------------------
// $1-ID , $2-RegKey; $3 - Amount, $4 - CC; $5 CC Expiry;
// $6= Transaction code 1- card present , 14 Process using Wallet ID, 4 Refund;
// $7= Payment Profile ID;
// $8 = true - Direct Debit;


C_TEXT($1;$2;$4;$5;$7)
C_BOOLEAN($8)
C_REAL($3)
C_LONGINT($6)
C_TEXT($0)
C_BOOLEAN($IsCC)
C_TEXT($root)
C_TEXT($subelem)
C_TEXT($namespace)

errMessage_t:=""
$ErrorCode:=""
$rspCode:=""
$swchKey:=""
$tranNr:=""
$extRspCode:=""
$IsCC:=False
$CardPresent:=$6
$Amount:=$3
$Amount:=$Amount*100

ON ERR CALL("ErrorWS")

$namespace:="http://postilion/realtime/merchantframework/xsd/v1/"
$root:=DOM Create XML Ref("SendTranRequest";$namespace)

$subelem:=DOM Create XML element($root;"SendTranRequest/merc/id")
DOM SET XML ELEMENT VALUE($subelem;$1)

$subelem:=DOM Create XML element($root;"SendTranRequest/merc/regKey")
DOM SET XML ELEMENT VALUE($subelem;$2)

$subelem:=DOM Create XML element($root;"SendTranRequest/merc/inType")
DOM SET XML ELEMENT VALUE($subelem;"1")

Case of 
: ($CardPresent=1)//CC Card present

$subelem:=DOM Create XML element($root;"SendTranRequest/tranCode")
DOM SET XML ELEMENT VALUE($subelem;"1")

If (vTrack#"")
$subelem:=DOM Create XML element($root;"SendTranRequest/card/trk1")
DOM SET XML ELEMENT VALUE($subelem;vTrack)
Else 
$subelem:=DOM Create XML element($root;"SendTranRequest/card/pan")
DOM SET XML ELEMENT VALUE($subelem;$4)

$subelem:=DOM Create XML element($root;"SendTranRequest/card/xprDt")
DOM SET XML ELEMENT VALUE($subelem;Substring($5;3;2)+Substring($5;1;2))
$IsCC:=True
End if 
vTrack:=""

: ($CardPresent=14)//CC\DD Wallet Sale
$subelem:=DOM Create XML element($root;"SendTranRequest/tranCode")
DOM SET XML ELEMENT VALUE($subelem;"14")

: ($CardPresent=4)//CC Credit/ Refund

$subelem:=DOM Create XML element($root;"SendTranRequest/tranCode")
DOM SET XML ELEMENT VALUE($subelem;"4")

$subelem:=DOM Create XML element($root;"SendTranRequest/reqAmt")
DOM SET XML ELEMENT VALUE($subelem;"0"+String($Amount))//leading 0

$subelem:=DOM Create XML element($root;"SendTranRequest/origTranData/tranNr")
DOM SET XML ELEMENT VALUE($subelem;vTransID)

: ($CardPresent=16)// DD Cancel/ refund

$subelem:=DOM Create XML element($root;"SendTranRequest/tranCode")
DOM SET XML ELEMENT VALUE($subelem;"16")

$subelem:=DOM Create XML element($root;"SendTranRequest/origTranData/tranNr")
DOM SET XML ELEMENT VALUE($subelem;vTransID)

End case 

If ($CardPresent=14) | ($CardPresent=1)
$subelem:=DOM Create XML element($root;"SendTranRequest/reqAmt")
DOM SET XML ELEMENT VALUE($subelem;"0"+String($Amount))//leading 0
End if 


Case of 
: ($CardPresent=1)
$subelem:=DOM Create XML element($root;"SendTranRequest/indCode")
DOM SET XML ELEMENT VALUE($subelem;"1")
: ($CardPresent=14)

If ($8=False)
$subelem:=DOM Create XML element($root;"SendTranRequest/indCode")
DOM SET XML ELEMENT VALUE($subelem;"0")
End if 

$subelem:=DOM Create XML element($root;"SendTranRequest/recurMan/id")
DOM SET XML ELEMENT VALUE($subelem;$7)

End case 

DOM EXPORT TO VAR($root;$Message)

If ($IsCC)
MaskCCLog ($Message;"Transaction Express")
Else 
SyncRecordLog ("TrxExpress Request: "+$Message)
End if 



WEB SERVICE SET PARAMETER("XMLIn";$root)

WEB SERVICE CALL("https://ws.cert.transactionexpress.com:443/portal/merchantframework/MerchantWeb"+"Services-v1";"";"SendTran";"";Web Service manual)

If (OK=1)
C_BLOB($blob)
C_TEXT($resroot)
C_TEXT($ressubelem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)
$resroot:=DOM Parse XML variable($blob)

$ressubelem:=DOM Find XML element($resroot;"SendTranResponse/rspCode")
DOM GET XML ELEMENT VALUE($ressubelem;$rspCode)

If (Length($rspCode)=2)// Received response from Trx Express
If ($rspCode="00")//Success - get all data
$ressubelem:=DOM Find XML element($resroot;"SendTranResponse/tranData/swchKey")
DOM GET XML ELEMENT VALUE($ressubelem;$swchKey)
[Trxs]CCAuthNo:=$swchKey

$ressubelem:=DOM Find XML element($resroot;"SendTranResponse/tranData/stan")
DOM GET XML ELEMENT VALUE($ressubelem;$tranNr)
[Trxs]OriginalReceipt:=$tranNr

$ressubelem:=DOM Find XML element($resroot;"SendTranResponse/tranData/tranNr")
DOM GET XML ELEMENT VALUE($ressubelem;$tranNr)
[Trxs]CCTransID:=$tranNr

DOM EXPORT TO VAR($resroot;$Message)
SyncRecordLog ($Message)
$0:=$swchKey

Else 
//Error Codes 
$ressubelem:=DOM Find XML element($resroot;"SendTranResponse/extRspCode")
DOM GET XML ELEMENT VALUE($ressubelem;$extRspCode)
$0:="ERR"+$rspCode+" "+$extRspCode
TrxExpressErrorCodes ($rspCode;$extRspCode)

If (errMessage_t="")
$ressubelem:=DOM Find XML element($resroot;"SendTranResponse/achResponse/Message")
DOM GET XML ELEMENT VALUE($ressubelem;errMessage_t)
End if 

AlertMessage ("Result Code: "+$rspCode+" "+$extRspCode+" Message: "+errMessage_t)
SyncRecordLog ("Result Code: "+$rspCode+" "+$extRspCode+" Message: "+errMessage_t)
vCCText:=errMessage_t
End if 

Else 
$name:=""
DOM GET XML ELEMENT NAME($resroot;$name)
$ressubelem:=DOM Find XML element($resroot;"S:Fault/detail/SystemFault/errorCode")
DOM GET XML ELEMENT VALUE($ressubelem;$ErrorCode)

$ressubelem:=DOM Find XML element($resroot;"S:Fault/detail/SystemFault/message")
DOM GET XML ELEMENT VALUE($ressubelem;errMessage_t)

AlertMessage ("Result Code: "+$ErrorCode+" Message: "+errMessage_t)
SyncRecordLog ("Result Code: "+$ErrorCode+" Message: "+errMessage_t)
vCCText:=errMessage_t
$0:="ERR"+$ErrorCode
End if 

DOM EXPORT TO VAR($resroot;$Message)
SyncRecordLog ("TrxExpress Response: "+$Message)
DOM CLOSE XML($resroot)
Else 
$0:="ERR SOAP"
End if 

DOM CLOSE XML($root)