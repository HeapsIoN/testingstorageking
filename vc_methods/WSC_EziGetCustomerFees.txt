//%attributes = {"lang":"en"} comment added and reserved by 4D.

// ----------------------------------------------------
// User name (OS): denis.mikheev
// Date and time: 22/10/15, 13:36:21
// ----------------------------------------------------
// Method: WSC_EziGetCustomerFees
// https://api.demo.ezidebit.com.au/v3-5/no-pci?singleWsdl
// 
// Method source code automatically generated by the 4D SOAP wizard.
// Description
// 
//
// Parameters
// ----------------------------------------------------

C_REAL($0)// String Fee to be returned
C_TEXT($1)// Digital Key
C_TEXT($2)// Eizdebit Cust ID
C_TEXT($3)// YourSystemReference
C_TEXT($4)//PaymentSource // WEB
C_TEXT($5)//Username
C_BOOLEAN($6)//Show Errors
C_BOOLEAN($7)//True - Use Card on File / False - Enter card
C_BOOLEAN($8)//WEB

// ----------------------------------------------------------------

ARRAY TEXT(arEzidebitCustomerID;0)
ARRAY REAL(arFeeAmount;0)
ARRAY REAL(arFeeMaximumAmount;0)
ARRAY REAL(arFeeMinimumAmount;0)
ARRAY TEXT(arFeeName;0)
ARRAY REAL(arFeePercent;0)
ARRAY TEXT(arProductName;0)
ARRAY TEXT(arProductVariant;0)
ARRAY TEXT(arYourSystemReference;0)

C_BOOLEAN($FeeRetrived;$Web)
C_TEXT($WordToSearch;$FeeName;vXMLResponse)
C_REAL($FeePercent;$FeeFixed;$Pos)
$WordToSearch:=""
$Product:=""
$FeeName:=""
$Web:=False

If (Count parameters=8)
$Web:=$8
End if 


C_TEXT($proxy_ret1)
C_REAL($proxy_ret2)
C_REAL($proxy_ret3)
C_REAL($proxy_ret4)
C_TEXT($proxy_ret5)
C_REAL($proxy_ret6)
C_TEXT($proxy_ret7)
C_TEXT($proxy_ret8)
C_TEXT($proxy_ret9)
C_LONGINT($proxy_ret10;$EziResult;$Count;$i)
C_TEXT($proxy_ret11;vCCText)
C_TEXT($Message)
vCCText:=""
$Message:=""
$Count:=0
$i:=0

$oldErrMethod:=Method called on error

ON ERR CALL("ERR_Ezi")

C_TEXT($root)
C_TEXT($subElem)
C_TEXT($nameSpace)
$nameSpace:="https://px.ezidebit.com.au/"
$root:=DOM Create XML Ref("GetCustomerFees";$nameSpace)

$subElem:=DOM Create XML element($root;"/GetCustomerFees/DigitalKey")
DOM SET XML ELEMENT VALUE($subElem;$1)

$subElem:=DOM Create XML element($root;"/GetCustomerFees/EziDebitCustomerID")
DOM SET XML ELEMENT VALUE($subElem;$2)

$subElem:=DOM Create XML element($root;"/GetCustomerFees/YourSystemReference")
DOM SET XML ELEMENT VALUE($subElem;$3)

$subElem:=DOM Create XML element($root;"/GetCustomerFees/PaymentSource")
DOM SET XML ELEMENT VALUE($subElem;$4)

$subElem:=DOM Create XML element($root;"/GetCustomerFees/Username")
DOM SET XML ELEMENT VALUE($subElem;$5)

WEB SERVICE SET PARAMETER("XMLIn";$root)

DOM EXPORT TO VAR($root;$Message)
//SET TEXT TO PASTEBOARD($Message)
SyncRecordLog ("EziDebit GetCustFees. Highlander: "+String([Facility]Highlander)+" Request: "+$Message)

If ([Facility]TestAccount)
WEB SERVICE CALL("https://api.demo.ezidebit.com.au/v3-5/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetCustomerFees";"GetCustomerFees";"https://px.ezidebit.com.au/";Web Service manual)
Else 
WEB SERVICE CALL("https://api.ezidebit.com.au/v3-5/nonpci";"https://px.ezidebit.com.au/INonPCIService/GetCustomerFees";"GetCustomerFees";"https://px.ezidebit.com.au/";Web Service manual)
End if 

$EziResult:=Num(WEB SERVICE Get info(0))

If ($EziResult=0)
C_BLOB($blob)
C_TEXT($resRoot)
C_TEXT($resSubElem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)
$resRoot:=DOM Parse XML variable($blob)
$Message:=""
DOM EXPORT TO VAR($resroot;$Message)
//SET TEXT TO PASTEBOARD($Message)
SyncRecordLog ("EziDebit GetCustomerFee Response: "+$Message)

If ($Web)// Return the message
vXMLResponse:=$Message
End if 

$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerFeesResponse/GetCustomerFeesResult/Error")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret10)//Error

If ($proxy_ret10=0)// no errors

//Retriving the number of fees
$GetCustomerFeesResultRef:=DOM Get first child XML element($resRoot)
$DataRef:=DOM Get first child XML element($GetCustomerFeesResultRef)
$CustomerFeeRef:=DOM Get first child XML element($DataRef)

$Count:=DOM Count XML elements($DataRef;"CustomerFee")

//looping throuhg all fees
For ($i;1;$Count)

$proxy_ret1:=""
$resSubElem:=DOM Find XML element($CustomerFeeRef;"CustomerFee/EzidebitCustomerID")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret1)
APPEND TO ARRAY(arEzidebitCustomerID;$proxy_ret1)

$proxy_ret2:=0
$resSubElem:=DOM Find XML element($CustomerFeeRef;"CustomerFee/FeeAmount")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret2)
APPEND TO ARRAY(arFeeAmount;$proxy_ret2)

$proxy_ret3:=0
$resSubElem:=DOM Find XML element($CustomerFeeRef;"CustomerFee/FeeMaximumAmount")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret3)
APPEND TO ARRAY(arFeeMaximumAmount;$proxy_ret3)

$proxy_ret4:=0
$resSubElem:=DOM Find XML element($CustomerFeeRef;"CustomerFee/FeeMinimumAmount")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret4)
APPEND TO ARRAY(arFeeMinimumAmount;$proxy_ret4)

$proxy_ret5:=""
$resSubElem:=DOM Find XML element($CustomerFeeRef;"CustomerFee/FeeName")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret5)
APPEND TO ARRAY(arFeeName;$proxy_ret5)

$proxy_ret6:=0
$resSubElem:=DOM Find XML element($CustomerFeeRef;"CustomerFee/FeePercent")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret6)
APPEND TO ARRAY(arFeePercent;$proxy_ret6)

$proxy_ret7:=""
$resSubElem:=DOM Find XML element($CustomerFeeRef;"CustomerFee/ProductName")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret7)
APPEND TO ARRAY(arProductName;$proxy_ret7)

$proxy_ret8:=""
$resSubElem:=DOM Find XML element($CustomerFeeRef;"CustomerFee/ProductVariant")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret8)
APPEND TO ARRAY(arProductVariant;$proxy_ret8)

$proxy_ret9:=""
$resSubElem:=DOM Find XML element($CustomerFeeRef;"CustomerFee/YourSystemReference")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret9)
APPEND TO ARRAY(arYourSystemReference;$proxy_ret9)

$CustomerFeeRef:=DOM Get next sibling XML element($CustomerFeeRef)

End for 

//$0:=True
Else 
$resSubElem:=DOM Find XML element($resRoot;"/GetCustomerFeesResponse/GetCustomerFeesResult/ErrorMessage")
DOM GET XML ELEMENT VALUE($resSubElem;$proxy_ret11)
SyncRecordLog ("EziDebit GetCustFees error: "+String($proxy_ret10)+" Message: "+$proxy_ret11)
//$0:=False
End if 

DOM CLOSE XML($resRoot)

Else 
$Pos:=0
$Pos:=Position("<s:Envelope";gError)
If ($Pos>0)
gError:=Substring(gError;$Pos)
TEXT TO BLOB(gError;$blob)
$resroot:=DOM Parse XML variable($blob)

$ressubelem:=DOM Find XML element($resroot;"/Envelope/Body/Fault/detail/ExceptionDetail/Message")
If ($ressubelem#"0000000000000000")
DOM GET XML ELEMENT VALUE($ressubelem;vCCText)
End if 
End if 

If (vCCText="")
vCCText:=gError
End if 

SyncRecordLog ("EziDebit GetCustFees call result: "+String($EziResult)+" Message: "+gError)
If ($6) & (Not(IsAWebProcess ))
AlertMessage ("EziDebit call result, error code: "+String($EziResult)+" (Unable to process update)")
End if 
//$0:=False

If ($Web)// Return the message
vXMLResponse:=$Message
End if 

End if 

DOM CLOSE XML($root)
ON ERR CALL($oldErrMethod)


//Default Card type is Visa
$WordToSearch:="Webpay Visa MSF"
$Product:="WebPay - Visa/MasterCard"

// Standard name for all CC types
$FeeName:="Webpay Transaction Fee"

If ($7=True)// Use Special option to detect the cardtype

If ([Customer]CustomerCode#"@MISCL")

Case of 
: ([Customer]SpecialOption=55)//Amex
$WordToSearch:="Webpay Amex MSF"
$Product:="WebPay - Amex"
: ([Customer]SpecialOption=56)//Diners
$WordToSearch:="Webpay Diners MSF"
$Product:="WebPay - Diners"
: ([Customer]SpecialOption=62)//Master Card
$WordToSearch:="Webpay Mastercard MSF"
$Product:="WebPay - Visa/MasterCard"
Else //Visa and 0
$WordToSearch:="Webpay Visa MSF"
$Product:="WebPay - Visa/MasterCard"
End case 

Else 

End if 

Else //Use vCCNo 

If (vCCNo="51@") | (vCCNo="52@") | (vCCNo="53@") | (vCCNo="54@") | (vCCNo="55@")
$WordToSearch:="Webpay Mastercard MSF"
$Product:="WebPay - Visa/MasterCard"
End if 

If (vCCNo="37@") | (vCCNo="34@")//It is an Amex card
$WordToSearch:="Webpay Amex MSF"
$Product:="WebPay - Amex"
End if 

If ((vCCNo="300@") | (vCCNo="301@") | (vCCNo="38@") | (vCCNo="39@") | (vCCNo="309@") | (vCCNo="302@") | (vCCNo="303@") | (vCCNo="304@") | (vCCNo="305@") | (vCCNo="36@")) & (([Facility]Country#"US") & ([Facility]Country#"CA"))//10461 - adding new Diners CC number
$WordToSearch:="Webpay Diners MSF"
$Product:="WebPay - Diners"
End if 

End if 

$FeePercent:=0
$FeeFixed:=0

$Pos:=0
// One Fee
$Pos:=Find in array(arFeeName;"@"+$WordToSearch+"@")

If ($Pos>0)
$FeePercent:=$FeePercent+arFeePercent{$Pos}
$FeeFixed:=$FeeFixed+arFeeAmount{$Pos}
End if 

$Pos:=0
// Second fee
$Pos:=Find in array(arFeeName;"@"+$FeeName+"@")
If ($Pos>0)
While ($Pos>0)
If ($Product=arProductVariant{$Pos})
$FeePercent:=$FeePercent+arFeePercent{$Pos}
$FeeFixed:=$FeeFixed+arFeeAmount{$Pos}
End if 

$Pos:=Find in array(arFeeName;"@"+$FeeName+"@";$pos+1)
End while 

End if 

//Clearing arrays

COPY ARRAY(arFeeName;WS_CCtype1)
COPY ARRAY(arFeeAmount;WS_FixedFee1)
COPY ARRAY(arFeePercent;WS_PercentFee1)

CLEAR VARIABLE(arEzidebitCustomerID)
CLEAR VARIABLE(arFeeAmount)
CLEAR VARIABLE(arFeeMaximumAmount)
CLEAR VARIABLE(arFeeMinimumAmount)
CLEAR VARIABLE(arFeeName)
CLEAR VARIABLE(arFeePercent)
CLEAR VARIABLE(arProductName)
CLEAR VARIABLE(arProductVariant)
CLEAR VARIABLE(arYourSystemReference)

$0:=((([Trxs]TotAmt)*$FeePercent)/100)+$FeeFixed