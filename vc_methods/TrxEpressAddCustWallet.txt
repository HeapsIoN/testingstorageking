//%attributes = {"lang":"en"} comment added and reserved by 4D.
// This method is used to add/update a customer profile + add/update a wallet for the customer

// proxy_UpdtRecurrProf
// https://ws.cert.transactionexpress.com/portal/merchantframework/MerchantWebServices-v1?wsdl
// 
// Method source code automatically generated by the 4D SOAP wizard.
//
// ----------------------------------------------------------------
//$1- ID; $2-RegKey
//$3="5" Debit CC card ="4" ACH
//$4="0" Add ="1" Update
//$5-CCNo;$6-Expiry date
//$7="1" active customer ="0" inactive



C_TEXT($1;$2;$3;$4;$5;$6)
C_TEXT($0)


C_TEXT($root)
C_TEXT($subelem)
C_TEXT($namespace;PaymentID;custID;$ErrorCode;$Active)
C_TEXT(errMessage_t;$rspCode)
errMessage_t:=""
$ErrorCode:=""
$rspCode:=""

$prodType:=$3
$Type:=$4
$Active:=$7

ON ERR CALL("ErrorWS")

If ($Type="0")// Add Customer + Wallet in one WS call
$namespace:="http://postilion/realtime/merchantframework/xsd/v1/"
$root:=DOM Create XML Ref("UpdtRecurrProfRequest";$namespace)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/id")
DOM SET XML ELEMENT VALUE($subelem;$1)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/regKey")
DOM SET XML ELEMENT VALUE($subelem;$2)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/inType")
DOM SET XML ELEMENT VALUE($subelem;"1")

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/prodType")
DOM SET XML ELEMENT VALUE($subelem;$prodType)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/type")
DOM SET XML ELEMENT VALUE($subelem;$Type)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/fullName")
DOM SET XML ELEMENT VALUE($subelem;[Customer]CustomerName)

// Optional
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/coName")
DOM SET XML ELEMENT VALUE($subelem;Substring([Customer]CustomerName;1;30))

If ([Customer]MobilePhone#"")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/phone/type")
DOM SET XML ELEMENT VALUE($subelem;"2")//2 - mobile phone number

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/phone/nr")
DOM SET XML ELEMENT VALUE($subelem;[Customer]MobilePhone)
End if 

If ([Customer]MailAddress#"")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/addrLn1")
DOM SET XML ELEMENT VALUE($subelem;[Customer]MailAddress)
End if 

If ([Customer]MailPostZIPCode#"")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/zipCode")
DOM SET XML ELEMENT VALUE($subelem;[Customer]MailPostZIPCode)
End if 

If ([Customer]EmailAddress#"")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/email")
DOM SET XML ELEMENT VALUE($subelem;[Customer]EmailAddress)
End if 

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/type")
DOM SET XML ELEMENT VALUE($subelem;"1")

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/stat")//0 - Inactive, 1 - Active
DOM SET XML ELEMENT VALUE($subelem;$Active)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/type")
DOM SET XML ELEMENT VALUE($subelem;"0")

If ($prodType="5")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/card/pan")
DOM SET XML ELEMENT VALUE($subelem;$5)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/card/xprDt")
DOM SET XML ELEMENT VALUE($subelem;$6)//$6 Expiry date
End if 

If ($prodType="4")

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/ach/bankRtNr")
If (vBankBSB="")
DOM SET XML ELEMENT VALUE($subelem;[Customer]BSB)
Else 
DOM SET XML ELEMENT VALUE($subelem;vBankBSB)
End if 

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/ach/acctNr")
If (vBankAccNo="")
DOM SET XML ELEMENT VALUE($subelem;[Customer]BankAcct)
Else 
DOM SET XML ELEMENT VALUE($subelem;vBankAccNo)
End if 

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/ach/acctType")
If ([Customer]AccountType=0)// If Account Type is 0 assume it is checking
DOM SET XML ELEMENT VALUE($subelem;String([Customer]AccountType))
Else 
DOM SET XML ELEMENT VALUE($subelem;String([Customer]AccountType-1))// 0- Cheking, 1 - savings.
End if 

End if 

DOM EXPORT TO VAR($root;$Message)
If ($prodType="5")
MaskCCLog ($Message;"TrxEpressAddCustWallet")
Else 
SyncRecordLog ("TrxExpress Upload Customer Request: "+$Message)
End if 
WEB SERVICE SET PARAMETER("XMLIn";$root)

WEB SERVICE CALL("https://ws.cert.transactionexpress.com:443/portal/merchantframework/MerchantWeb"+"Services-v1";"";"UpdtRecurrProf";"";Web Service manual)

If (OK=1)
C_BLOB($blob)
C_TEXT($resroot)
C_TEXT($ressubelem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)
$resroot:=DOM Parse XML variable($blob)

$ressubelem:=DOM Find XML element($resroot;"UpdtRecurrProfResponse/rspCode")
DOM GET XML ELEMENT VALUE($ressubelem;$rspCode)

If (Length($rspCode)=2)

If (($rspCode="00"))
If ($prodType="5")
$ressubelem:=DOM Find XML element($resroot;"UpdtRecurrProfResponse/custId")
DOM GET XML ELEMENT VALUE($ressubelem;custID)
[Customer]customerProfileID:=custID

$ressubelem:=DOM Find XML element($resroot;"UpdtRecurrProfResponse/pmtId")
DOM GET XML ELEMENT VALUE($ressubelem;PaymentID)
[Customer]custPaymentProfID:=PaymentID
Else 
$ressubelem:=DOM Find XML element($resroot;"UpdtRecurrProfResponse/custId")
DOM GET XML ELEMENT VALUE($ressubelem;custID)
[Customer]DDProfileID:=custID

$ressubelem:=DOM Find XML element($resroot;"UpdtRecurrProfResponse/pmtId")
DOM GET XML ELEMENT VALUE($ressubelem;PaymentID)
[Customer]DDPaymentProfileID:=PaymentID
End if 

SAVE RECORD([Customer])
$0:=""

Else 
// Response Codes go here
AlertMessage ("Result Code: "+$rspCode+" Message: "+errMessage_t)
SyncRecordLog ("Result Code: "+$rspCode+" Message: "+errMessage_t)
$0:="ERR"+$ErrorCode
End if 

Else 
$name:=""
DOM GET XML ELEMENT NAME($resroot;$name)
$ressubelem:=DOM Find XML element($resroot;"S:Fault/detail/SystemFault/errorCode")
DOM GET XML ELEMENT VALUE($ressubelem;$ErrorCode)

$ressubelem:=DOM Find XML element($resroot;"S:Fault/detail/SystemFault/message")
DOM GET XML ELEMENT VALUE($ressubelem;errMessage_t)

AlertMessage ("Result Code: "+$ErrorCode+" Message: "+errMessage_t)
SyncRecordLog ("Result Code: "+$ErrorCode+" Message: "+errMessage_t)

$0:="ERR"+$ErrorCode
End if 
DOM EXPORT TO VAR($resroot;$Message)
SyncRecordLog ("TrxExpress Upload Customer Response: "+$Message)
DOM CLOSE XML($resroot)

End if 
DOM CLOSE XML($root)

Else // Update customer then update wallet

$namespace:="http://postilion/realtime/merchantframework/xsd/v1/"
$root:=DOM Create XML Ref("UpdtRecurrProfRequest";$namespace)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/id")
DOM SET XML ELEMENT VALUE($subelem;$1)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/regKey")
DOM SET XML ELEMENT VALUE($subelem;$2)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/inType")
DOM SET XML ELEMENT VALUE($subelem;"1")

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/type")
DOM SET XML ELEMENT VALUE($subelem;$Type)

If ($prodType="5")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/id")
DOM SET XML ELEMENT VALUE($subelem;[Customer]customerProfileID)
Else 
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/id")
DOM SET XML ELEMENT VALUE($subelem;[Customer]DDProfileID)
End if 

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/fullName")
DOM SET XML ELEMENT VALUE($subelem;[Customer]CustomerName)

// Optional
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/coName")
DOM SET XML ELEMENT VALUE($subelem;[Customer]CustomerName)

If ([Customer]MobilePhone#"")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/phone/type")
DOM SET XML ELEMENT VALUE($subelem;"2")//2 - mobile phone number

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/phone/nr")
DOM SET XML ELEMENT VALUE($subelem;[Customer]MobilePhone)
End if 

If ([Customer]MailAddress#"")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/addrLn1")
DOM SET XML ELEMENT VALUE($subelem;[Customer]MailAddress)
End if 

If ([Customer]MailPostZIPCode#"")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/zipCode")
DOM SET XML ELEMENT VALUE($subelem;[Customer]MailPostZIPCode)
End if 

If ([Customer]EmailAddress#"")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/email")
DOM SET XML ELEMENT VALUE($subelem;[Customer]EmailAddress)
End if 

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/type")
DOM SET XML ELEMENT VALUE($subelem;"1")

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/stat")//0 - Inactive, 1 - Active
DOM SET XML ELEMENT VALUE($subelem;$Active)

DOM EXPORT TO VAR($root;$Message)
SyncRecordLog ("TrxExpress Update Customer Request: "+$Message)

WEB SERVICE SET PARAMETER("XMLIn";$root)
WEB SERVICE CALL("https://ws.cert.transactionexpress.com:443/portal/merchantframework/MerchantWeb"+"Services-v1";"";"UpdtRecurrProf";"";Web Service manual)

If (OK=1)
C_BLOB($blob)
C_TEXT($resroot)
C_TEXT($ressubelem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)
$resroot:=DOM Parse XML variable($blob)

$ressubelem:=DOM Find XML element($resroot;"UpdtRecurrProfResponse/rspCode")
DOM GET XML ELEMENT VALUE($ressubelem;$rspCode)

If (Length($rspCode)=2)
If ($rspCode="00")
AlertMessage ("Customer profile has been updated successfully!")
$0:=""
Else 

If (errMessage_t="")
$ressubelem:=DOM Find XML element($resroot;"SendTranResponse/achResponse/Message")
DOM GET XML ELEMENT VALUE($ressubelem;errMessage_t)
End if 

AlertMessage ("Result Code: "+$rspCode+" "+$extRspCode+" Message: "+errMessage_t)
SyncRecordLog ("Result Code: "+$rspCode+" "+$extRspCode+" Message: "+errMessage_t)
//Error Codes here
AlertMessage ("Result Code: "+$rspCode+" Message: "+errMessage_t)
SyncRecordLog ("Result Code: "+$rspCode+" Message: "+errMessage_t)
$0:="ERR"+$rspCode
End if 
Else 

$name:=""
DOM GET XML ELEMENT NAME($resroot;$name)
$ressubelem:=DOM Find XML element($resroot;"S:Fault/detail/SystemFault/errorCode")
DOM GET XML ELEMENT VALUE($ressubelem;$ErrorCode)

$ressubelem:=DOM Find XML element($resroot;"S:Fault/detail/SystemFault/message")
DOM GET XML ELEMENT VALUE($ressubelem;errMessage_t)

AlertMessage ("Result Code: "+$ErrorCode+" Message: "+errMessage_t)
SyncRecordLog ("Result Code: "+$ErrorCode+" Message: "+errMessage_t)
$0:="ERR"+$ErrorCode
End if 

DOM EXPORT TO VAR($resroot;$Message)
SyncRecordLog ("TrxExpress Update Customer Response: "+$Message)
DOM CLOSE XML($resroot)

End if 
DOM CLOSE XML($root)


If ($rspCode="00")
// Update Wallet Data
$namespace:="http://postilion/realtime/merchantframework/xsd/v1/"
$root:=DOM Create XML Ref("UpdtRecurrProfRequest";$namespace)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/id")
DOM SET XML ELEMENT VALUE($subelem;$1)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/regKey")
DOM SET XML ELEMENT VALUE($subelem;$2)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/inType")
DOM SET XML ELEMENT VALUE($subelem;"1")

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/merc/prodType")
DOM SET XML ELEMENT VALUE($subelem;$prodType)

If ($prodType="5")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/id")
DOM SET XML ELEMENT VALUE($subelem;[Customer]customerProfileID)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/id")
DOM SET XML ELEMENT VALUE($subelem;[Customer]custPaymentProfID)
Else 
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/contact/id")
DOM SET XML ELEMENT VALUE($subelem;[Customer]DDProfileID)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/id")
DOM SET XML ELEMENT VALUE($subelem;[Customer]DDPaymentProfileID)
End if 

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/type")
DOM SET XML ELEMENT VALUE($subelem;$Type)


If ($prodType="5")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/card/pan")
DOM SET XML ELEMENT VALUE($subelem;$5)

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/card/xprDt")
DOM SET XML ELEMENT VALUE($subelem;$6)//$6 Expiry date
End if 


If ($prodType="4")
$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/ach/bankRtNr")
If (vBankBSB="")
DOM SET XML ELEMENT VALUE($subelem;[Customer]BSB)
Else 
DOM SET XML ELEMENT VALUE($subelem;vBankBSB)
End if 

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/ach/acctNr")
If (vBankAccNo="")
DOM SET XML ELEMENT VALUE($subelem;[Customer]BankAcct)
Else 
DOM SET XML ELEMENT VALUE($subelem;vBankAccNo)
End if 

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/ach/acctType")
If ([Customer]AccountType=0)// If Account Type is 0 assume it is checking
DOM SET XML ELEMENT VALUE($subelem;String([Customer]AccountType))
Else 
DOM SET XML ELEMENT VALUE($subelem;String([Customer]AccountType-1))// 0- Cheking, 1 - savings.
End if 
End if 

$subelem:=DOM Create XML element($root;"UpdtRecurrProfRequest/cust/pmt/status")
DOM SET XML ELEMENT VALUE($subelem;$Active)

DOM EXPORT TO VAR($root;$Message)
SyncRecordLog ("TrxExpress Update Wallet Request: "+$Message)

WEB SERVICE SET PARAMETER("XMLIn";$root)

WEB SERVICE CALL("https://ws.cert.transactionexpress.com:443/portal/merchantframework/MerchantWeb"+"Services-v1";"";"UpdtRecurrProf";"";Web Service manual)

If (OK=1)
C_BLOB($blob)
C_TEXT($resroot)
C_TEXT($ressubelem)
WEB SERVICE GET RESULT($blob;"XMLOut";*)
$resroot:=DOM Parse XML variable($blob)

$ressubelem:=DOM Find XML element($resroot;"UpdtRecurrProfResponse/rspCode")
DOM GET XML ELEMENT VALUE($ressubelem;$rspCode)

If (Length($rspCode)=2)
If ($rspCode="00")
$0:=""
AlertMessage ("Customer wallet has been updated successfully!")
Else 
If (errMessage_t="")
$ressubelem:=DOM Find XML element($resroot;"SendTranResponse/achResponse/Message")
DOM GET XML ELEMENT VALUE($ressubelem;errMessage_t)
End if 
//Error Codes here
AlertMessage ("Result Code: "+$rspCode+" Message: "+errMessage_t)
SyncRecordLog ("Result Code: "+$rspCode+" Message: "+errMessage_t)
$0:="ERR"+$rspCode
End if 
Else 

$name:=""
DOM GET XML ELEMENT NAME($resroot;$name)
$ressubelem:=DOM Find XML element($resroot;"S:Fault/detail/SystemFault/errorCode")
DOM GET XML ELEMENT VALUE($ressubelem;$ErrorCode)

$ressubelem:=DOM Find XML element($resroot;"S:Fault/detail/SystemFault/message")
DOM GET XML ELEMENT VALUE($ressubelem;errMessage_t)

AlertMessage ("Result Code: "+$ErrorCode+" Message: "+errMessage_t)
SyncRecordLog ("Result Code: "+$ErrorCode+" Message: "+errMessage_t)
$0:="ERR"+$ErrorCode
End if 
DOM EXPORT TO VAR($resroot;$Message)
SyncRecordLog ("TrxExpress Update Wallet Response: "+$Message)
DOM CLOSE XML($resroot)

End if 
DOM CLOSE XML($root)
End if 
End if 

