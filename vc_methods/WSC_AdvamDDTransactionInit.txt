//%attributes = {"lang":"en"} comment added and reserved by 4D.
// 
// WSC_AdvamDDTransactionInit
// https://demo-ftp.advam.com/batch/ws/V1/BulkSubmission.wsdl
// 
// Method source code automatically generated by the 4D SOAP wizard.
// ----------------------------------------------------------------

C_TEXT($1;$2;$3)
C_TEXT($0;$statement_xpath;$value_t;$ErrMethod)
C_BLOB($outputblob;$replyblob)
C_TEXT($xmlref;$xmlnode)
C_LONGINT($TCPID)

$ErrMethod:=""
$TCPID:=0
SET BLOB SIZE($outputblob;0)


vAdvamAcc:=$1

vUser:=$2
vPass:=$3

$ErrMethod:=Method called on error

// Modified by: nicholas.wykes (7/01/2010)
//Change from disk file to DOM XML format

$root:=DOM Create XML Ref("soapenv:Envelope";"http://schemas.xmlsoap.org/soap/envelope/";"xmlns:sch";"http://batch.advam.com/V1/schema")

$subelem:=DOM Create XML element($root;"/soapenv:Envelope/soapenv:Header")

$subelem:=DOM Create XML element($root;"/soapenv:Envelope/soapenv:Body/sch:InitializeRequest/sch:AdvamAccount")
DOM SET XML ELEMENT VALUE($subelem;vAdvamAcc)

$subelem:=DOM Create XML element($root;"/soapenv:Envelope/soapenv:Body/sch:InitializeRequest/sch:OperatorUsername")
DOM SET XML ELEMENT VALUE($subelem;vUser)

$subelem:=DOM Create XML element($root;"/soapenv:Envelope/soapenv:Body/sch:InitializeRequest/sch:OperatorPassword")
DOM SET XML ELEMENT VALUE($subelem;vPass)

WEB SERVICE SET PARAMETER("XMLIn";$root)

DOM CLOSE XML($root)



ON ERR CALL("ErrorWS")
If ([Facility]TestAccount)//Demo Account / Server
$Error:=TCP_Open ("demo-ftp.advam.com";443;$TCPID;0)
If ($Error=0)
$Error:=TCP_Close ($TCPID)
$Error:=IT_SetTimeOut (65)
WEB SERVICE CALL("https://demo-ftp.advam.com/batch/ws/V1/soap.php";"http://batch.advam.com/InitializeBulkSubmission";"Initialize";"";Web Service manual)
End if 
Else //Live Account / Server
$Error:=TCP_Open ("ftp.advam.com";443;$TCPID;0)
If ($Error=0)
$Error:=TCP_Close ($TCPID)
$Error:=IT_SetTimeOut (65)
WEB SERVICE CALL("https://ftp.advam.com/batch/ws/V1/soap.php";"http://batch.advam.com/V1/schema";"Initialize";"";Web Service manual)
End if 
End if 





If (OK=1)
WEB SERVICE GET RESULT($replyblob;"XMLOut";*)
$xmlref:=DOM Parse XML variable($replyblob)

$statement_xpath:="/InitializeResponse/Success"
$xmlnode:=DOM Find XML element($xmlref;$statement_xpath)

If ($xmlnode#"0000000000000000")
DOM GET XML ELEMENT VALUE($xmlnode;$value_t)
WS_AdvamSuccess:=$value_t
End if 

$statement_xpath:="/InitializeResponse/Batch"
$xmlnode:=DOM Find XML element($xmlref;$statement_xpath)

If ($xmlnode#"0000000000000000")
DOM GET XML ELEMENT VALUE($xmlnode;$value_t)
WS_BatchNumber:=$value_t
End if 
DOM CLOSE XML($xmlref)
If (WS_AdvamSuccess="true") | (WS_AdvamSuccess="1")
$0:=WS_BatchNumber
Else 
$0:=""
End if 
End if 

$Error:=IT_SetTimeOut (30)
ON ERR CALL($ErrMethod)
